Лог	= Справочники.А_ЛогПроизводительности.СоздатьЭлемент();
Лог.Наименование	= "Отчет ДлительностьДиагностик_Основной. "+ПараметрыСеанса.ТекущийПользователь;
Лог.Дата	= ТекущаяДата();
Действие	= Лог.Действия.Добавить();
Действие.Наименование	= "Клиент: Формирование запроса к 1С";
Действие.Начало	= ТекущаяУниверсальнаяДатаВМиллисекундах();

//====
// Запрос: Загрузка данных
//====
ТекстЗапроса	= "
|ВЫБРАТЬ
|	А_Заявка.Ссылка,
|	А_Заявка.Мастер,
|	А_Заявка.Дата,
|	А_Заявка.Отказ,
|	А_Заявка.ДомАдрессныйКлассификатор,
|	А_Заявка.Повторная,
|	А_Заявка.Направление,
|	А_Заявка.ЗаявленнаяНеисправность1,
|	А_Заявка.ЗаявленнаяНеисправность2
|ПОМЕСТИТЬ Заявки
|ИЗ
|	Документ.А_Заявка КАК А_Заявка
|ГДЕ
|	(ДОБАВИТЬКДАТЕ(А_Заявка.ДатаЗакрытия, НЕДЕЛЯ, 1) >= &НачалоПериода
|			ИЛИ А_Заявка.ДатаЗакрытия = ДАТАВРЕМЯ(1, 1, 1))
|	И А_Заявка.Дата < &КонецПериода
|	И НЕ А_Заявка.Мастер = ЗНАЧЕНИЕ(Справочник.А_Мастера.ПустаяСсылка)
|	И (&Направление = ЗНАЧЕНИЕ(Справочник.Айсберг_Направления.ПустаяСсылка)
|			ИЛИ А_Заявка.Направление = &Направление)
|	И (&Мастер = ЗНАЧЕНИЕ(Справочник.А_Мастера.ПустаяСсылка)
|			ИЛИ А_Заявка.Мастер = &Мастер)
|	И (&Заявка = ЗНАЧЕНИЕ(Документ.А_Заявка.ПустаяСсылка)
|			ИЛИ А_Заявка.Ссылка = &Заявка)
|
|СГРУППИРОВАТЬ ПО
|	А_Заявка.Ссылка,
|	А_Заявка.Мастер,
|	А_Заявка.Дата,
|	А_Заявка.Отказ,
|	А_Заявка.ДомАдрессныйКлассификатор,
|	А_Заявка.Повторная,
|	А_Заявка.Направление,
|	А_Заявка.ЗаявленнаяНеисправность1,
|	А_Заявка.ЗаявленнаяНеисправность2
|
|ИНДЕКСИРОВАТЬ ПО
|	А_Заявка.ДомАдрессныйКлассификатор
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ РАЗЛИЧНЫЕ
|	Заявки.Мастер
|ПОМЕСТИТЬ МастераЗаявок
|ИЗ
|	Заявки КАК Заявки
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	А_МастераДомашниеКоординаты.Ссылка КАК Мастер,
|	А_МастераДомашниеКоординаты.GPS_N,
|	А_МастераДомашниеКоординаты.GPS_E
|ПОМЕСТИТЬ ДомашниеКоординаты
|ИЗ
|	Справочник.А_Мастера.ДомашниеКоординаты КАК А_МастераДомашниеКоординаты
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ МастераЗаявок КАК МастераЗаявок
|		ПО А_МастераДомашниеКоординаты.Ссылка = МастераЗаявок.Мастер
|
|ИНДЕКСИРОВАТЬ ПО
|	Мастер
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	МРМ_Координаты.Мастер КАК Мастер,
|	МРМ_Координаты.Устройство КАК Устройство,
|	МИНИМУМ(МРМ_Координаты.Период) КАК ПериодНач,
|	МРМ_Координаты.GPS_N,
|	МРМ_Координаты.GPS_E
|ПОМЕСТИТЬ КоординатыНач
|ИЗ
|	РегистрСведений.МРМ_Координаты КАК МРМ_Координаты
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ МастераЗаявок КАК МастераЗаявок
|		ПО МРМ_Координаты.Мастер = МастераЗаявок.Мастер
|ГДЕ
|	МРМ_Координаты.Период >= &НачалоПериода
|	И МРМ_Координаты.Период < &КонецПериода
|
|СГРУППИРОВАТЬ ПО
|	МРМ_Координаты.Мастер,
|	МРМ_Координаты.Устройство,
|	МРМ_Координаты.GPS_N,
|	МРМ_Координаты.GPS_E
|
|ИНДЕКСИРОВАТЬ ПО
|	Мастер,
|	Устройство,
|	ПериодНач
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	КоординатыНач1.Мастер КАК Мастер,
|	КоординатыНач1.Устройство КАК Устройство,
|	КоординатыНач1.ПериодНач КАК ПериодНач,
|	КоординатыНач1.GPS_N,
|	КоординатыНач1.GPS_E,
|	МИНИМУМ(КоординатыНач2.ПериодНач) КАК ПериодКон
|ПОМЕСТИТЬ КоординатыВсе
|ИЗ
|	КоординатыНач КАК КоординатыНач1
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КоординатыНач КАК КоординатыНач2
|		ПО КоординатыНач1.Мастер = КоординатыНач2.Мастер
|			И КоординатыНач1.Устройство = КоординатыНач2.Устройство
|			И КоординатыНач1.ПериодНач < КоординатыНач2.ПериодНач
|			И (НАЧАЛОПЕРИОДА(КоординатыНач1.ПериодНач, ДЕНЬ) = НАЧАЛОПЕРИОДА(КоординатыНач2.ПериодНач, ДЕНЬ))
|
|СГРУППИРОВАТЬ ПО
|	КоординатыНач1.Мастер,
|	КоординатыНач1.Устройство,
|	КоординатыНач1.ПериодНач,
|	КоординатыНач1.GPS_N,
|	КоординатыНач1.GPS_E
|
|ИНДЕКСИРОВАТЬ ПО
|	Мастер,
|	Устройство,
|	ПериодНач,
|	ПериодКон
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	КоординатыВсе.Мастер КАК Мастер,
|	КоординатыВсе.Устройство,
|	КоординатыВсе.ПериодНач КАК ПериодНач,
|	КоординатыВсе.GPS_N КАК GPS_N_1,
|	КоординатыВсе.GPS_E КАК GPS_E_1,
|	РАЗНОСТЬДАТ(КоординатыВсе.ПериодНач, КоординатыВсе.ПериодКон, СЕКУНДА) КАК ДлительностьДоСледующегоСмещения,
|	КоординатыКон.GPS_N КАК GPS_N_2,
|	КоординатыКон.GPS_E КАК GPS_E_2
|ПОМЕСТИТЬ КоординатыМастеров
|ИЗ
|	КоординатыВсе КАК КоординатыВсе
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КоординатыНач КАК КоординатыКон
|		ПО КоординатыВсе.Мастер = КоординатыКон.Мастер
|			И КоординатыВсе.Устройство = КоординатыКон.Устройство
|			И КоординатыВсе.ПериодКон = КоординатыКон.ПериодНач
|
|ИНДЕКСИРОВАТЬ ПО
|	Мастер,
|	ПериодНач,
|	GPS_N_1,
|	GPS_E_1,
|	GPS_N_2,
|	GPS_E_2
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	А_АдресныйКлассификатор.Широта * 10 КАК GPSN,
|	А_АдресныйКлассификатор.Долгота * 10 КАК GPSE,
|	Заявки.Мастер,
|	Заявки.Ссылка,
|	Заявки.Дата,
|	Заявки.Отказ,
|	Заявки.ДомАдрессныйКлассификатор,
|	Заявки.Повторная,
|	Заявки.Направление,
|	Заявки.ЗаявленнаяНеисправность1,
|	Заявки.ЗаявленнаяНеисправность2,
|	МРМ_ПолуквадратКоординат.Значение КАК Полуквадрат
|ПОМЕСТИТЬ КоординатыЗаявок
|ИЗ
|	Заявки КАК Заявки
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.А_АдресныйКлассификатор КАК А_АдресныйКлассификатор
|		ПО Заявки.ДомАдрессныйКлассификатор = А_АдресныйКлассификатор.Ссылка
|			И (НЕ А_АдресныйКлассификатор.Широта = 0)
|			И (НЕ А_АдресныйКлассификатор.Долгота = 0),
|	Константа.МРМ_ПолуквадратКоординат КАК МРМ_ПолуквадратКоординат
|
|ИНДЕКСИРОВАТЬ ПО
|	GPSN,
|	GPSE
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	МРМ_Координаты.Мастер КАК Мастер,
|	МРМ_Координаты.ПериодНач КАК ВремяГеоПозиции,
|	МРМ_Координаты.ДлительностьДоСледующегоСмещения / 60 КАК ДлительностьМинут,
|	МРМ_Координаты.ДлительностьДоСледующегоСмещения КАК ДлительностьСекунд,
|	НАЧАЛОПЕРИОДА(МРМ_Координаты.ПериодНач, ДЕНЬ) КАК ДатаДень,
|	КоординатыЗаявок.Ссылка КАК Ссылка,
|	КоординатыЗаявок.GPSN,
|	КоординатыЗаявок.GPSE,
|	МРМ_Координаты.GPS_N_1,
|	МРМ_Координаты.GPS_E_1,
|	КоординатыЗаявок.ДомАдрессныйКлассификатор КАК Дом,
|	КоординатыЗаявок.Отказ,
|	КоординатыЗаявок.Повторная,
|	КоординатыЗаявок.Направление,
|	КоординатыЗаявок.ЗаявленнаяНеисправность1,
|	КоординатыЗаявок.ЗаявленнаяНеисправность2,
|	МИНИМУМ(ВЫБОР
|			КОГДА КоординатыЗаявок.GPSN > ЕСТЬNULL(ДомашниеКоординаты.GPS_N, 0)
|				ТОГДА КоординатыЗаявок.GPSN - ЕСТЬNULL(ДомашниеКоординаты.GPS_N, КоординатыЗаявок.GPSN)
|			ИНАЧЕ ЕСТЬNULL(ДомашниеКоординаты.GPS_N, КоординатыЗаявок.GPSN) - КоординатыЗаявок.GPSN
|		КОНЕЦ + ВЫБОР
|			КОГДА КоординатыЗаявок.GPSE > ЕСТЬNULL(ДомашниеКоординаты.GPS_E, 0)
|				ТОГДА КоординатыЗаявок.GPSE - ЕСТЬNULL(ДомашниеКоординаты.GPS_E, КоординатыЗаявок.GPSE)
|			ИНАЧЕ ЕСТЬNULL(ДомашниеКоординаты.GPS_E, КоординатыЗаявок.GPSE) - КоординатыЗаявок.GPSE
|		КОНЕЦ) КАК ЗаявкаДомРасстояние
|ПОМЕСТИТЬ СборкаЗаявок
|ИЗ
|	КоординатыЗаявок КАК КоординатыЗаявок
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КоординатыМастеров КАК МРМ_Координаты
|		ПО КоординатыЗаявок.Мастер = МРМ_Координаты.Мастер
|			И КоординатыЗаявок.Дата < МРМ_Координаты.ПериодНач
|			И (МРМ_Координаты.GPS_N_1 > КоординатыЗаявок.GPSN - КоординатыЗаявок.Полуквадрат)
|			И (МРМ_Координаты.GPS_N_1 < КоординатыЗаявок.GPSN + КоординатыЗаявок.Полуквадрат)
|			И (МРМ_Координаты.GPS_E_1 > КоординатыЗаявок.GPSE - КоординатыЗаявок.Полуквадрат)
|			И (МРМ_Координаты.GPS_E_1 < КоординатыЗаявок.GPSE + КоординатыЗаявок.Полуквадрат)
|			И (МРМ_Координаты.GPS_N_2 > КоординатыЗаявок.GPSN - КоординатыЗаявок.Полуквадрат)
|			И (МРМ_Координаты.GPS_N_2 < КоординатыЗаявок.GPSN + КоординатыЗаявок.Полуквадрат)
|			И (МРМ_Координаты.GPS_E_2 > КоординатыЗаявок.GPSE - КоординатыЗаявок.Полуквадрат)
|			И (МРМ_Координаты.GPS_E_2 < КоординатыЗаявок.GPSE + КоординатыЗаявок.Полуквадрат)
|		ЛЕВОЕ СОЕДИНЕНИЕ ДомашниеКоординаты КАК ДомашниеКоординаты
|		ПО КоординатыЗаявок.Мастер = ДомашниеКоординаты.Мастер
|ГДЕ
|	КоординатыЗаявок.Ссылка.Диагностика
|
|СГРУППИРОВАТЬ ПО
|	МРМ_Координаты.Мастер,
|	МРМ_Координаты.ДлительностьДоСледующегоСмещения / 60,
|	МРМ_Координаты.ДлительностьДоСледующегоСмещения,
|	МРМ_Координаты.ПериодНач,
|	КоординатыЗаявок.Ссылка,
|	КоординатыЗаявок.GPSN,
|	КоординатыЗаявок.GPSE,
|	МРМ_Координаты.GPS_N_1,
|	МРМ_Координаты.GPS_E_1,
|	КоординатыЗаявок.ДомАдрессныйКлассификатор,
|	КоординатыЗаявок.Отказ,
|	КоординатыЗаявок.Повторная,
|	КоординатыЗаявок.Направление,
|	КоординатыЗаявок.ЗаявленнаяНеисправность1,
|	КоординатыЗаявок.ЗаявленнаяНеисправность2
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ЕСТЬNULL(СборкаЗаявок.Ссылка.ТоварнаяГруппа.Код, 0) КАК field_1,
|	ЕСТЬNULL(СборкаЗаявок.Направление.Код, 0) КАК field_2,
|	ЕСТЬNULL(СборкаЗаявок.ЗаявленнаяНеисправность1.Код, 0) КАК field_3,
|	ЕСТЬNULL(СборкаЗаявок.ЗаявленнаяНеисправность2.Код, 0) КАК field_4,
|	ЕСТЬNULL(А_ОтчетМастераРаботы.Работа.Код, 0) КАК field_5,
|	СборкаЗаявок.Мастер.Код КАК field_6,
|	СборкаЗаявок.Ссылка.Номер КАК field_7,
|	СУММА(СборкаЗаявок.ДлительностьСекунд) КАК field_8,
|	СборкаЗаявок.Ссылка КАК field_11,
|	ЕСТЬNULL(СборкаЗаявок.Ссылка.ТоварнаяГруппа, ЗНАЧЕНИЕ(Справочник.А_ТоварныеГруппы.ПустаяСсылка)) КАК field_12,
|	ЕСТЬNULL(СборкаЗаявок.Направление, ЗНАЧЕНИЕ(Справочник.Айсберг_Направления.ПустаяСсылка)) КАК field_13,
|	ЕСТЬNULL(СборкаЗаявок.ЗаявленнаяНеисправность1, ЗНАЧЕНИЕ(Справочник.А_Неисправности.ПустаяСсылка)) КАК field_14,
|	ЕСТЬNULL(СборкаЗаявок.ЗаявленнаяНеисправность2, ЗНАЧЕНИЕ(Справочник.А_Неисправности.ПустаяСсылка)) КАК field_15,
|	ЕСТЬNULL(А_ОтчетМастераРаботы.Работа, ЗНАЧЕНИЕ(Справочник.А_Работы.ПустаяСсылка)) КАК field_16,
|	СборкаЗаявок.Мастер КАК field_17
|ИЗ
|	СборкаЗаявок КАК СборкаЗаявок
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.А_ОтчетМастера.Работы КАК А_ОтчетМастераРаботы
|		ПО (А_ОтчетМастераРаботы.Ссылка.Дата >= &НачалоПериода)
|			И (А_ОтчетМастераРаботы.Ссылка.Дата < &КонецПериода)
|			И (А_ОтчетМастераРаботы.Ссылка.Заявка = СборкаЗаявок.Ссылка)
|			И (А_ОтчетМастераРаботы.Ссылка.Проведен)
|			И (А_ОтчетМастераРаботы.Ссылка.ОтчетМастера)
|			И (А_ОтчетМастераРаботы.Работа.СчитатьДисконтнойКартой = ЛОЖЬ)
|			И (А_ОтчетМастераРаботы.Ссылка.ДокументКорректировки = ЗНАЧЕНИЕ(документ.А_ОтчетМастера.ПустаяСсылка))
|ГДЕ
|	(&УдаленностьОтДома = 0
|			ИЛИ СборкаЗаявок.ЗаявкаДомРасстояние / 100 > &УдаленностьОтДома)
|
|СГРУППИРОВАТЬ ПО
|	СборкаЗаявок.Ссылка.Номер,
|	СборкаЗаявок.Ссылка,
|	СборкаЗаявок.Направление.Код,
|	СборкаЗаявок.Направление,
|	СборкаЗаявок.ЗаявленнаяНеисправность1.Код,
|	СборкаЗаявок.ЗаявленнаяНеисправность1,
|	СборкаЗаявок.ЗаявленнаяНеисправность2.Код,
|	СборкаЗаявок.ЗаявленнаяНеисправность2,
|	А_ОтчетМастераРаботы.Работа.Код,
|	А_ОтчетМастераРаботы.Работа,
|	ЕСТЬNULL(СборкаЗаявок.Ссылка.ТоварнаяГруппа.Код, 0),
|	ЕСТЬNULL(СборкаЗаявок.Ссылка.ТоварнаяГруппа, ЗНАЧЕНИЕ(Справочник.А_ТоварныеГруппы.ПустаяСсылка)),
|	СборкаЗаявок.Мастер,
|	СборкаЗаявок.Мастер.Код";

Элемент	= Справочники.A_SqlData.СоздатьЭлемент();
Элемент.Наименование			= ""+ТекущаяДата()+" ДлительностьДиагностик_Основной";
Элемент.ИдентификаторЗапроса	= Новый УникальныйИдентификатор;
Элемент.ТекстЗапроса			= ТекстЗапроса;

Параметр	= Элемент.ПараметрыЗапроса.Добавить();
Параметр.Наименование	= "НачалоПериода";
Параметр.Значение		= Дата(ЭтотОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти("НачалоПериода").Значение);

Параметр	= Элемент.ПараметрыЗапроса.Добавить();
Параметр.Наименование	= "КонецПериода";
Параметр.Значение		= Дата(ЭтотОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти("КонецПериода").Значение);

Параметр	= Элемент.ПараметрыЗапроса.Добавить();
Параметр.Наименование	= "Направление";
Параметр.Значение		= ЭтотОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти("Направление").Значение;

Параметр	= Элемент.ПараметрыЗапроса.Добавить();
Параметр.Наименование	= "Заявка";
Параметр.Значение		= ЭтотОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти("Заявка").Значение;

Параметр	= Элемент.ПараметрыЗапроса.Добавить();
Параметр.Наименование	= "Мастер";
Параметр.Значение		= ЭтотОбъект.КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти("Мастер").Значение;

Параметр	= Элемент.ПараметрыЗапроса.Добавить();
Параметр.Наименование	= "УдаленностьОтДома";
Параметр.Значение		= 1000;
	
СтрокаИБ	= СтрокаСоединенияИнформационнойБазы();
СтрокаИБ	= СтрЗаменить(СтрокаИБ,"""","");
СтрокаИБ	= СтрЗаменить(СтрокаИБ,"=","");
СтрокаИБ	= СтрЗаменить(СтрокаИБ,";","");
СтрокаИБ	= СтрЗаменить(СтрокаИБ,"/","");
СтрокаИБ	= СтрЗаменить(СтрокаИБ,"\","");

Элемент.КоличествоПолей	= 6;

Модель	= Элемент.Модели.Добавить();
Модель.Наименование			= "diagostics_duration_company_tn12r_"+СтрокаИБ;
Модель.КоличествоПолей		= 5;
Модель.НомерПоляРезультата	= 9;

Модель	= Элемент.Модели.Добавить();
Модель.Наименование			= "diagostics_duration_master_tn12rm_"+СтрокаИБ;
Модель.КоличествоПолей		= 6;
Модель.НомерПоляРезультата	= 10;

Элемент.Записать();

Действие.Конец	= ТекущаяУниверсальнаяДатаВМиллисекундах();
Действие.Длительность	= Действие.Конец-Действие.Начало;
Действие.КоличествоДействий	= 1;
Лог.Записать();

А_Питон.Предсказание(Элемент.Код,Лог.Код);

//====
// Передача данных в отчет
//====
Лог	= Справочники.А_ЛогПроизводительности.НайтиПоКоду(Лог.Код).ПолучитьОбъект();
Действие	= Лог.Действия.Добавить();
Действие.Наименование	= "Клиент: Заполнение источника данных";
Действие.Начало	= ТекущаяУниверсальнаяДатаВМиллисекундах();

Запрос	= Новый Запрос;
Запрос.УстановитьПараметр("ИдентификаторЗапроса",Элемент.ИдентификаторЗапроса);

Запрос.Текст	= "
		|ВЫБРАТЬ
		|	A_SqlData.field_8,
		|	A_SqlData.field_9,
		|	A_SqlData.field_10,
		|	A_SqlData.field_11,
		|	A_SqlData.field_12,
		|	A_SqlData.field_13,
		|	A_SqlData.field_14,
		|	A_SqlData.field_15,
		|	A_SqlData.field_16,
		|	A_SqlData.field_17
		|ИЗ
		|	Справочник.A_SqlData.Данные КАК A_SqlData ГДЕ A_SqlData.Ссылка.ИдентификаторЗапроса=&ИдентификаторЗапроса";
ВнешниеНаборыДанных.Вставить("ТабЗначенийСКД",Запрос.Выполнить().Выгрузить());
Элемент.Ссылка.ПолучитьОбъект().Удалить();
Действие.Конец	= ТекущаяУниверсальнаяДатаВМиллисекундах();
Действие.Длительность	= Действие.Конец-Действие.Начало;
Действие.КоличествоДействий	= 1;
Лог.Записать();